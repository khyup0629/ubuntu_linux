# VMware vSphere

vSphere : ESXi Server, vCenter 그리고 여러 기능들이 포함된 패키지

## SDDC(Software Defined DataCenter)

데이터센터의 모든 인프라가 가상화되고 서비스로 제공되며, 데이터센터 전체를 소프트웨어로 구성하여 자동으로 제어·관리할 수 있는 데이터센터   

단순히 각 벤더의 하드웨어 위에 가상화가 별도로 이루어지는 것이 아닌 데이터센터 전체(서버, 스토리지, 네트워크)를 가상화하겠다는 의미.

> <h3>SDDC의 개별 요소</h3>

![image](https://user-images.githubusercontent.com/43658658/143796942-87b29728-b93f-48ce-82a9-303f23cfc180.png)

#### 컴퓨팅 요소

vSphere와 같은 컴퓨팅 가상화입니다. CPU, 메모리, 디스크 등 서버 자원이 컴퓨팅 가상화의 대상입니다.

#### 네트워크 요소

네트워크 서비스 및 장비에 대한 자동화 부분입니다. 기존에 하드웨어 장비로 존재하던 스위치, 라우터, 방화벽 등이 가상화로 완전히 전환됩니다.

#### 스토리지 요소

가상으로 구축 가능한 스토리지 구성요소입니다. 더이상 기존에 구축하던 외장형의 스토리지 장비가 필요 없어지고 서버의 로컬 내장 디스크로 구현됩니다.   
기존 하드웨어 중심의 스토리지 관리에서 VM 중심의 스토리지 관리로 이동하는 것입니다.

#### 매니지먼트 요소

서버, 네트워크, 스토리지의 각 구성 요소가 가상화되고 이를 Private Cloud 형태로 구축하고 클라우드 관리에 대한 솔루션 및 프레임워크를 제공하는 부분입니다.

## CPU 가상화 동작의 개요

ESXi에서는 물리적인 CPU를 가상화하여 가상머신에 할당할 수 있습니다.

> <h3>특징</h3>

물리 서버에 존재하는 복수의 논리 CPU의 부하를 동적으로 로드밸런싱합니다.
* CPU의 단위 : 소켓 -> 코어 -> 쓰레드
* 코어의 자원을 ESXi 서버가 실시간으로 여러 대의 가상머신에 동적으로 분배합니다.

동적으로 물리/논리 CPU에 대한 모니터링을 실시하면서 동적으로 특정 CPU에 부하가 집중되는 것을 방지합니다.
* 수십 밀리 세컨드 단위로 전체 CPU를 체크하면서 여유가 있는 CPU 자원을 확인한 다음 전체 가상머신에 골고루 할당합니다.

## 메모리 가상화 기술 개요

1. 투명한 페이지 공유 기술 : 효율적 메모리 관리
2. 메모리 벌루닝 기술 : 효율적 메모리 관리
3. 메모리 압축 기술 : 시스템 보호
4. VMKernel 스왑 기술 : 시스템 보호

> <h3>투명한 페이지 공유</h3>

![image](https://user-images.githubusercontent.com/43658658/143798470-e947039c-3bab-439b-8fa0-e4119798bb39.png)

가상머신 사이에서 동일한 정적 메모리 페이지를 공유하는 기능입니다.   
여러 대의 가상머신이 하나의 물리적인 서버 위에서 운용될 때 동일한 종류의 가상머신일 경우 같은 페이지를 사용하기도 합니다.   
이런 동일한 가상 페이지를 물리적인 하드웨어의 같은 페이지를 참조하도록 설정합니다.

> <h3>메모리 벌루닝</h3>

동작을 멈추고 있는 상태의 가상머신이 보유하고 있는 메모리 영역을 회수하여, 다른 가상머신에게 할당해주는 기능입니다.   
다른 가상머신에서 메모리가 모자라 하이퍼바이저에 요구할 때 발생합니다.

![image](https://user-images.githubusercontent.com/43658658/143798802-90673aef-b8aa-4a93-9b79-0cc92781c16c.png)
가상머신은 실제 메모리를 자신이 모두 사용한다고 생각합니다.   
VMtools 중 Driver를 이용해서 오버헤드를 일으켜 스왑파일로 오버헤드된 메모리 페이지를 `실제 메모리`에 저장(Swap Out)하고, 
확보된 메모리 페이지를 스왑파일에서 메모리가 필요한 가상머신으로 할당해줍니다.

> <h3>메모리 압축</h3>

메모리에 동일한 데이터가 있다면 동일한 데이터를 메모리 안에서 압축하는 기능입니다.   
가상머신에 메모리 요구가 발생하고 메모리를 회수할 수 없는 상황이 되었을 경우 발생합니다.

메모리 데이터를 압축하여 VMKernel 스왑을 줄이고 퍼포먼스 저하를 방지하는 기능입니다.

> <h3>VMKernel 스왑</h3>

물리 메모리가 부족한 경우, VMKernel은 가상머신의 메모리를 `디스크`의 스왑파일에 스왑 아웃합니다.   
모든 가상머신이 Busy해서 메모리가 부족할 때 발생하는 현상입니다.   
앞선 3가지 기술이 모두 적용될 수 없을 때 마지막에 사용하는 기술입니다.   

메모리 벌루닝과의 차이점은 메모리 벌루닝은 메모리에 스왑 아웃하지만, VMKernel 스왑은 `디스크`에 스왑 아웃한다는 것입니다.   
메모리에서 디스크로 스왑 아웃을 하기 때문에 전체적인 성능에 영향을 미칩니다.

## 스토리지 가상화 기술

> <h3>RAID 기술</h3>

#### RAID 0(스트라이핑)

데이터를 각각의 디스크에 나눠 담는 방식입니다(속도 중점).   
![image](https://user-images.githubusercontent.com/43658658/143440757-316b2a1c-a267-4f9c-8ce6-f8fdbfeff0df.png)

장점   
* 하드디스크의 개수 만큼 `읽기·쓰기 속도가 증가`합니다(나눠진 만큼 대역폭이 증가하기 때문)   

단점   
* 안정성이 떨어집니다. 
  - 하드 하나라도 고장나면 전체 데이터를 잃어버립니다.

일회성 데이터나 빠른 작업을 위해 사용하고 마치면 바로 백업용 저장 공간으로 옮깁니다.

#### RAID 1(미러링)

각 디스크에 중복으로 데이터를 기록합니다(안정성 중점).   
대부분 `2개`의 디스크로 사용하고 2개를 초과하는 경우는 드뭅니다.   
![image](https://user-images.githubusercontent.com/43658658/143440904-cecc629f-f35f-4b1e-8439-b131bca3a7e5.png)

장점   
* 디스크 하나가 고장나더라도 `데이터가 보존`됩니다.   

단점   
* 하드의 용량을 `반` 밖에 쓰지 못합니다.

#### RAID 0+1

![image](https://user-images.githubusercontent.com/43658658/143804320-3d8f6e2c-a8ea-4b38-a6ec-ef0cf3e95b36.png)   
`4개`의 하드디스크를 사용해 RAID 0 방식으로 데이터를 `스트라이핑`하고, RAID 1 방식으로 `미러링`합니다.

장점   
* RAID 0의 속도적인 장점을 살리고, RAID 1으로 안정성을 보강

#### RAID 1+0

![image](https://user-images.githubusercontent.com/43658658/143803512-f42d6795-d2bb-4acc-9c85-3695e8fc2307.png)   
`4개`의 하드디스크를 사용해 RAID 1 방식으로 데이터를 `미러링`하고, 이를 다시 RAID 0 방식으로 `스트라이핑`하는 방식입니다.   

예를 들어, RAID 10 에 있는 4개의 400GB 하드디스크(총 1600GB)는 운영체제에서 하나의 800GB 하드디스크로 나타납니다.

장점   
* RAID 10은 RAID 0의 속도적인 장점을 살리고, RAID 1으로 안정성을 보강
* 한 디스크에서 장애가 발생할 경우, 데이터 무결성에 영향을 주지 않고 모든 데이터를 다른 미러에서 제공할 수 있고 고장난 드라이브만 교체하면 됩니다.
  - 데이터 무결성 : 데이터의 정확성과 일관성을 유지하고 보증하는 것.

#### RAID 10 vs RAID 01

![image](https://user-images.githubusercontent.com/43658658/143804320-3d8f6e2c-a8ea-4b38-a6ec-ef0cf3e95b36.png)
![image](https://user-images.githubusercontent.com/43658658/143803512-f42d6795-d2bb-4acc-9c85-3695e8fc2307.png)   

공통점   
* 용량과 속도는 같습니다.

차이점   
* 예를 들어, 그림에서 `Disk 0`과 `Disk 2`가 동시에 깨질 경우 RAID 01은 전체 디스크가 깨지지만, RAID 10은 복구가 가능합니다.   
(디스크가 `Disk 0`과 `Disk 1`이 깨질 경우 RAID 10도 전체 디스크가 깨지지만, 깨지는 확률이 더 낮습니다)
* 디스크를 재구성하는 속도가 RAID 10이 빠릅니다.   
(`Disk 0`이 깨질 경우 RAID 10은 바로 옆의 `Disk 1`에서 바로 리빌드하면 되지만, RAID 01은 `Disk 2`로부터 데이터가 넘어와야 합니다).

#### RAID 5(패리티)

`3개 이상`의 디스크가 요구됩니다(XOR 연산이 가능한 개수가 3개부터이기 때문입니다).   
각 디스크 별로 `패리티`라고 불리는 `복원 정보`를 담습니다.   
`하나의 디스크`가 고장 났을 때에만 복원이 가능합니다.   
![image](https://user-images.githubusercontent.com/43658658/143441154-3842b62f-8e98-4cb0-a938-1a8a69592d49.png)

장점   
* 안정성 증가
  - `복원이 가능`하기 때문입니다. 
* 읽기 속도 증가
  - `대역폭이 커지기` 때문입니다.
* 쓰기 속도 그대로
  - 패리티 연산과 기록의 `처리가 추가`되기 때문입니다.
* 용량 증가
  - `n-1` 배 증가합니다.
  - `패리티 저장 공간` 때문에 하드 1개 만큼의 용량을 뺍니다.

#### RAID 6(더블 패리티)

![image](https://user-images.githubusercontent.com/43658658/143810102-8c703bda-5132-4956-a8c1-aede4bbe392a.png)   
`패리티` 정보가 한 디스크에 2개씩 들어갑니다.   
따라서 2개의 디스크까지 고장나도 복원이 가능합니다.

장점   
* 안정성 대폭 증가
* RAID 5와 같은 읽기 속도 증가

단점   
* RAID 5보다 쓰기 속도가 느려집니다.
  - 2개의 패리티 연산과 기록이 필요하기 때문입니다.
* 복잡한 기술인 만큼, 데이터를 복원할 때 시간이 더욱 소요됩니다.

## 스토리지 연결 방식

> <h3>DAS(Direct Attached Storage)</h3>

![image](https://user-images.githubusercontent.com/43658658/143812672-86f21cce-2269-49df-8861-98e56bbce04e.png)   
서버(컴퓨팅 노드)와 스토리지가 `직접 연결`되는 방식입니다. 네트워크 상의 다른 서버는 저장된 데이터에 액세스할 수 없습니다.   
이때 쓰이는 프로토콜은 FC이며 FC 케이블을 통해서 서로 연결됩니다.

* FC(Fibre Channel) : 서버 및 하이퍼바이저인 ESXi 호스트와 고성능 스토리지를 연결하는 특수한 고속 네트워크입니다.
  - FC는 FC 프로토콜을 통해 SCSI 트래픽을 가상 시스템에서 FC SAN 장비로 전송합니다.
  - FC는 물리적인 서버에 HBA이 설치되어 있어야 합니다.

> <h3>NAS(Network Attached Storage)</h3>

![image](https://user-images.githubusercontent.com/43658658/143812703-f8bd8678-28b3-45ce-8e3a-020f6f139ffe.png)   
`네트워크`를 통해 스토리지에 연결하는 방식입니다. 구축이 용이하고 저렴하며, 여러 컴퓨터가 동일한 저장소 공간을 공유할 수 있습니다.   
`NFS`와 같은 프로토콜을 통해 접속할 수 있습니다.

> <h3>SAN(Storage Area Network)</h3>

![image](https://user-images.githubusercontent.com/43658658/143812523-28c25af6-5de8-4135-8022-204338e291cd.png)   
서버와 스위치, 스위치와 스토리지가 연결된 방식입니다. 스위치는 SAN 방식을 지원하는 FC(Fibre Channel) 스위치입니다.   
서버와 스위치 사이에 FC 케이블을 통해 연결되어 있습니다. 고속이며 여러 서버에서 접근할 수 있습니다.

## VMware 전송 방식

> <h3>FC</h3>

FC(Fibre Channel) : 서버 및 하이퍼바이저인 ESXi 호스트와 고성능 스토리지를 연결하는 특수한 고속 네트워크입니다.
- FC는 FC 프로토콜을 통해 SCSI 트래픽을 가상 시스템에서 FC SAN 장비로 전송합니다.
- FC는 물리적인 서버에 `HBA`이 설치되어 있어야 합니다.

> <h3>iSCSI</h3>

SCSI 트래픽을 LAN 케이블을 사용하는 네트워크에서도 사용이 가능하도록 TCP/IP 프로토콜로 패키징해서 전송하는 방식입니다.

> <h3>FCoE(Fibre Channel over Ethernet)</h3>

네트워크를 통해 FC 프로토콜을 전송하는 방식입니다. SAN 네트워크를 위한 별도의 장비가 필요하지 않고 고속의 네트워크만 있다면 기존 네트워크 라인을 통해서도
SAN 형태의 스토리지를 연결할 수 있는 방식입니다.

> <h3>NFS(Network File Share)</h3>

NAS 방식으로 연결할 때 NFS 프로토콜을 통해 스토리지에 접근합니다.
`NIC`를 이용해 연결됩니다.

---

[참고 사이트]   
* [RAID 개념 1](https://hellowoori.tistory.com/53)
* [RAID 개념 2](https://www.prepressure.com/library/technology/raid)
* [스토리지 연결 방식](https://ma-you-ing.tistory.com/16)

